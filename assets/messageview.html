<!DOCTYPE html>
<html>
<head>
<style type="text/css">
body {
	width: 95%;
	font: normal 95%/1 "Helvetica Neue", "Arial", sans-serif;
}
#backlogBtn {
	width: 100%;
	height: 40px;
	display: none;
}
#messages div {
	word-wrap: break-word;
	padding-top: 2px;
	padding-bottom: 2px;
}
.timestamp {
	padding: 8px;
	color: #aaa;
}
.from {
	font-weight: bold;
	padding-right: 8px;
}
.highlight {
	background: #D9E7FF;
}
.self {
	background: #edf4ff;
}
.dateline {
	background: #eee;
	text-align: center;
}
.notice {
	background: #D9E7FF;
}
.buffer_me_msg .from:before {
	content:"* ";
}
.buffer_me_msg .from {
	font-style: italic;
}
.buffer_me_msg .message_text {
	font-style: italic;
}
.channel_topic {
	background: #eee;
}
.channel_topic .from {
	font-weight: normal;
}
.joined_channel .from:before {
	content:"-> ";
}
.joined_channel .from {
	font-weight: normal;
	color: #aaa;
}
.joined_channel .message_text {
	color: #aaa;
}
.parted_channel .from:before {
	content:"<- ";
}
.parted_channel .from {
	font-weight: normal;
	color: #aaa;
}
.parted_channel .message_text {
	color: #aaa;
}
.kicked_channel .from:before {
	content:"<- ";
}
.kicked_channel .from {
	font-weight: normal;
	color: #aaa;
}
.kicked_channel .message_text {
	color: #aaa;
}
.quit .from:before {
	content:"<= ";
}
.quit .from {
	font-weight: normal;
	color: #aaa;
}
.quit .message_text {
	color: #aaa;
}
.nickchange .from {
	font-weight: normal;
	color: #aaa;
}
.nickchange .message_text:before {
	content:"-> ";
}
.user_channel_mode .from:before {
	content:"+++ ";
}
.motd_response .timestamp {
	display: none;
}
.motd_response .from {
	display: none;
}
.motd_response {
	font-family: monospace;
    background: #edf4ff;
}
.inviting_to_channel {
	background: #D9E7FF;
}
.inviting_to_channel .from {
	display: none;
}
.channel_mode {
	background: #eee;
}
.channel_mode .from {
	display: none;
}
.channel_mode_is {
	background: #eee;
}
.channel_mode_is .from {
	display: none;
}
.self_details {
	background: #eee;
}
.self_details .from {
	display: none;
}
.user_mode {
	background: #eee;
}
.user_mode .from {
	display: none;
}
.myinfo {
	background: #eee;
}
.myinfo .from {
	display: none;
}
.connecting_failed {
	color: #aaa;
}
.connecting_failed .from {
	display: none;
}
.socket_closed .from {
	display: none;
}
.socket_closed .timestamp {
	display: none;
}
.error {
	background: #FFEE97;
}
.error .from {
	display: none;
}
.nickname_in_use {
	background: #FFEE97;
}
#newmsgbar {
	bottom: 0px;
	left: 0px;
	right: 0px;
	width: 100%;
	padding: 6px;
	background-color: blue;
	position: fixed;
	font-weight: bold;
	color: white;
	visibility: hidden;
}
</style>
<script type="text/javascript" src="Underscore.js"></script>
<script type="text/javascript" src="ignore.js"></script>
<script type="text/javascript">
var scrollTimer = null;
var lastDate = null;
var bid = 0;
var min_eid = 0;
var max_eid = 0;
var newMsgs = 0;
var newMsgsTime = 0;
var newMsgsTimer = null;
var prefs = null;
var ignores = null;
var backlogLoading = true;
var shouldScroll = true;
var topBacklogElement;
var topBacklogOffset = 0;

function hideBacklogBtn() {
	document.getElementById("backlogBtn").style.display = "none";
}

function showBacklogBtn() {
	document.getElementById("backlogBtn").style.display = "block";
}

function updateNewMsgBar(delta) {
	if(typeof delta != "number")
		delta = 0;
	var newmsgbar = document.getElementById("newmsgbar");
	if(window.pageYOffset < 10 && !backlogLoading && scrollTimer == null && document.getElementById("backlogBtn").style.display == "block") {
		fetchBacklog();
	}
	if(newMsgs == 0 || (document.body.scrollHeight - delta - (window.pageYOffset + window.innerHeight) < 20)) {
		document.getElementById("newmsgbar").style.visibility = "hidden";
		newmsgbar.innerHTML = "";
		newMsgs = 0;
		if(typeof newMsgsTimer != "null")
			window.clearTimeout(newMsgsTimer);
	} else {
		var then = new Date(newMsgsTime).getTime();
		var now = new Date().getTime();
		var minutes = Math.floor((now - then) / 60000);
		if(minutes < 1)
			newmsgbar.innerHTML = "less than a";
		else
			newmsgbar.innerHTML = minutes;
		newmsgbar.innerHTML += " minute";
		if(minutes > 1)
			newmsgbar.innerHTML += "s";
		newmsgbar.innerHTML += " of chatter (" + newMsgs + " message";
		if(newMsgs != 1)
			newmsgbar.innerHTML += "s";
		newmsgbar.innerHTML += ")";
		document.getElementById("newmsgbar").style.visibility = "visible";
		if(typeof newMsgsTimer != "null")
			window.clearTimeout(newMsgsTimer);
		newMsgsTimer = window.setTimeout(updateNewMsgBar,1000);
	}
}

window.onscroll = updateNewMsgBar;

function scrollToBottom(delta) {
	scrollTimer = "ignoreme"; //Don't fetch more backlog if we're scrolling
	if(typeof delta != "number")
		delta = 0;
	if(shouldScroll || document.body.scrollHeight - delta - (window.pageYOffset + window.innerHeight) < 20) {
		window.scrollTo(0, document.body.scrollHeight);
		shouldScroll = false;
	}
	updateNewMsgBar(delta);
	scrollTimer = null;
}

function scrollToBacklogBottom() {
	if(typeof scrollTimer != "null")
		window.clearTimeout(scrollTimer);
	scrollTimer = "ignoreme"; //Don't fetch more backlog if we're scrolling
    var _y = 0;
    var el = document.getElementById(topBacklogElement);
    while( el && !isNaN( el.offsetLeft ) && !isNaN( el.offsetTop ) ) {
        _y += el.offsetTop - el.scrollTop;
        el = el.offsetParent;
    }
    window.scrollTo(0, _y - topBacklogOffset);
    topBacklogOffset = 0;
    scrollTimer = null;
}

function fetchBacklog() {
	backlogLoading = true;
	document.getElementById("backlogBtn").style.disabled = true;
	var messages = document.getElementById("messages");
	for(var i = 1; i < messages.childNodes.length; i++) {
		if(messages.childNodes[i].style.display != "none") {
			topBacklogElement = messages.childNodes[i].id;
			break;
		}
	}
    var el = document.getElementById(topBacklogElement);
    while( el && !isNaN( el.offsetLeft ) && !isNaN( el.offsetTop ) ) {
        topBacklogOffset += el.offsetTop - el.scrollTop;
        el = el.offsetParent;
    }
	Android.requestBacklog();
}

function appendBacklog() {
	Android.log("Prefs: " + Android.getPrefs());
	prefs = JSON.parse(Android.getPrefs());
 	ignores = Ignore.parse(JSON.parse(Android.getIgnores()));
 	var start = new Date().getTime();
	var backlog = JSON.parse(Android.getIncomingBacklog());
	var elapsed = new Date().getTime() - start;
	Android.log("Backlog JSON parsing took " + elapsed + "ms");
	
	start = new Date().getTime();
	
	for(var j=0; j<backlog.length; j++) {
		appendEvent(backlog[j], false);
	}
	
	if(topBacklogOffset > 0) {
		var messages = document.getElementById("messages");
		if(document.getElementById("backlogGapIndicator") != null)
			messages.removeChild(document.getElementById("backlogGapIndicator"));
	    var el = document.getElementById(topBacklogElement).previousSibling;
	    while(typeof el.id != "string" || el.style.display == "none")
	    	el = el.previousSibling;
	    if(el.previousSibling != null) {
			var m = document.createElement("hr");
			m.id = "backlogGapIndicator";
			messages.insertBefore(m, el.nextSibling);
		}
	}

	elapsed = new Date().getTime() - start;
	Android.log("Backlog rendering took " + elapsed + "ms");
	Android.backlogComplete();
	newMsgs = 0;
	backlogLoading = false;
}

function appendEvent(msg,isBacklog) {
	bid = Android.getBid();
	var dateline = null;
	var messages = document.getElementById("messages");
	var m = document.createElement("div");

	if(typeof msg.value == "number") {
		msg.msg = msg.value + " " + msg.msg;
	}

	if(msg.type == "nickname_in_use") {
		msg.from = msg.nick;
		msg.msg = " is already in use";
	}

	if(msg.type == "connecting_failed") {
		msg.msg = "Failed to connect: " + msg.reason;
	}

	if(msg.type == "socket_closed") {
		if(msg.server_ping_timeout)
			msg.msg = "Connection PING timed out<br/><hr/>";
		else
			msg.msg = "<hr/>";
	}

	if(msg.type == "self_details") {
		msg.msg = "Your hostmask: <b>" + msg.usermask + "</b>";
	}

	if(msg.type == "myinfo") {
		msg.msg = "Host: " + msg.server + "<br/>";
		msg.msg += "IRCd: " + msg.version + "<br/>";
		msg.msg += "User modes: " + msg.user_modes + "<br/>";
		msg.msg += "Channel modes: " + msg.channel_modes + "<br/>";
	}

	if(msg.type == "user_mode") {
		msg.msg = "Your user mode is <b>" + msg.diff + "</b>";
	}

	if(msg.type == "channel_topic") {
		msg.from = msg.author;
		msg.msg = "set the topic: " + msg.topic;
	}
	
	if(msg.type == "channel_mode") {
		msg.msg = "Channel mode set to: <b>" + msg.diff + "</b>";
	}

	if(msg.type == "channel_mode_is") {
		msg.msg = "Channel mode is: <b>" + msg.diff + "</b>";
	}

	if(msg.type == "you_joined_channel")
		msg.type = "joined_channel";
		
	if(msg.type == "you_parted_channel")
		msg.type = "parted_channel";

	if(msg.type == "you_kicked_channel")
		msg.type = "kicked_channel";

	if(msg.type == "you_nickchange")
		msg.type = "nickchange";

	if(msg.type == "joined_channel") {
		msg.from = msg.nick;
		msg.msg = "joined (" + msg.hostmask + ")";
	}

	if(msg.type == "parted_channel") {
		msg.from = msg.nick;
		msg.msg = "left (" + msg.hostmask + ")";
	}

	if(msg.type == "kicked_channel") {
		msg.from = msg.nick;
		msg.msg = "was kicked by " + msg.kicker + " (" + msg.kicker_hostmask + "): " + msg.msg;
	}

	if(msg.type == "quit_server")
		msg.type = "quit";

	if(msg.type == "quit") {
		msg.from = msg.nick;
		if(typeof msg.hostmask == "string")
			msg.msg = "quit (" + msg.hostmask + ") " + msg.msg;
		else
			msg.msg = "quit: " + msg.msg;
	}
	
	if(msg.type == "nickchange") {
		msg.from = msg.oldnick;
		msg.msg = msg.newnick;
	}
	
	if(msg.type == "user_channel_mode") {
		msg.msg = "set mode: <b>" + msg.diff + " " + msg.nick + "</b>";
	}

	if(msg.type == "channel_mode_list_change") {
		msg.msg = "set mode: <b>" + msg.diff + "</b>";
	}

	if(msg.type == "motd_response") {
		msg.msg = "";
		for(var i=0; i<msg.lines.length; i++) {
			msg.msg += msg.lines[i] + "<br/>";			
		}
	}

	if(msg.type == "server_motd")
		msg.type = "motd_response";

	if(msg.type == "inviting_to_channel") {
		msg.from = "";
		msg.msg = "You invited " + msg.recipient + " to join " + msg.channel;
	}

	var mask = msg.from + "!" + msg.hostmask;
	if(ignores != null && Ignore.check(mask, ignores)) {
		m.style.display = "none";
	}

	if(prefs["channel-hideJoinPart"] && prefs["channel-hideJoinPart"][bid] && (msg.type == "joined_channel" || msg.type == "parted_channel" || msg.type == "nickchange" || msg.type == "quit"))
		m.style.display = "none";

	m.className = msg.type;

	if(msg.highlight)
		m.className += " highlight";

	if(msg.self)
		m.className += " self";

	var d = new Date(msg.eid/1000);
	var hours = d.getHours();
	var ampm = "";
	
	if(prefs != null && !prefs["time-24hr"]) {
		ampm = "AM";
		if(hours > 12) {
			hours = hours - 12;
			ampm = "PM";
		}
		if(hours == 0)
			hours = 12;
	}
	var minutes = d.getMinutes();
	if(minutes < 10) {
		minutes = "0" + minutes;
	}
	
	if(prefs != null && prefs["time-seconds"])
		minutes = minutes + ":" + d.getSeconds();
	
	m.id = msg.eid;
	m.innerHTML = "<span class='timestamp'>"+hours+":"+minutes+" "+ampm;
	if(typeof msg.from == "string")
		m.innerHTML += "</span><span class='from'>"+msg.from
	m.innerHTML += "</span><span class='message_text'>"+msg.msg
		+"</span>";
	
	if(m.style.display != "none" && (document.body.scrollHeight - (window.pageYOffset + window.innerHeight) < 20))
		shouldScroll = true;
	else
		shouldScroll = false;
		
	if(max_eid < msg.eid) { //Message at the bottom
		if(messages.childNodes.length > 0)
			lastDate = new Date(parseInt(messages.childNodes[messages.childNodes.length - 1].id)/1000);
		else
			lastDate = null;
		messages.appendChild(m);
	} else if(min_eid > msg.eid) { //Message goes on top
		lastDate = new Date(parseInt(messages.childNodes[1].id)/1000);
		if(d.getDate() != lastDate.getDate()) { //Insert above the dateline
			messages.insertBefore(m, messages.firstChild);
		} else { //Insert below the dateline
			messages.insertBefore(m, messages.childNodes[1]);
		}
	} else { //Message goes somewhere in the middle
		for(var i=0;i<messages.childNodes.length;i++) {
			var node = messages.childNodes[i];
			if(typeof node.id == "string" && parseInt(node.id) > 0) {
				var id = parseInt(node.id);
				if(id > msg.eid) {
					if(i > 0 && typeof messages.childNodes[i - 1].id == "string" && parseInt(messages.childNodes[i - 1].id) > 0) {
						lastDate = new Date(parseInt(messages.childNodes[i - 1].id)/1000);
						messages.insertBefore(m, node);
					} else if(i > 1) { //There was a dateline above our insertion point!
						lastDate = new Date(parseInt(node.id)/1000);
						if(d.getDate() != lastDate.getDate()) { //Insert above the dateline
							lastDate = new Date(parseInt(messages.childNodes[i - 2].id)/1000);
							messages.insertBefore(m, messages.childNodes[i - 1]);
						} else { //Insert below the dateline
							lastDate = new Date(msg.eid/1000);
							messages.insertBefore(m, node);
						}
					} else { //We shouldn't get here
						lastDate = new Date(msg.eid/1000);
						messages.insertBefore(m, node);
					}
					break;
				} else if(id == msg.eid) { //Replace the message
					messages.replaceChild(m, node);
					lastDate = new Date(msg.eid/1000);
					break;
				}
			}
		}
	}
	
	if(lastDate == null || d.getDate() != lastDate.getDate()) {
		dateline = document.createElement("div");
		dateline.className = "dateline";
		dateline.innerHTML = d.toLocaleDateString();
	}
	
	if(dateline != null)
		messages.insertBefore(dateline, m);
	
	if(max_eid < msg.eid)
		max_eid = msg.eid;
	if(min_eid == 0 || min_eid > msg.eid)
		min_eid = msg.eid;

	if(!isBacklog && m.style.display != "none")
		newMsgs++;

	if(newMsgs == 1)
		newMsgsTime = msg.eid / 1000;

	if(typeof scrollTimer != "null")
		window.clearTimeout(scrollTimer);

	if(topBacklogOffset == 0)
		scrollTimer = window.setTimeout(scrollToBottom,100);
	
}
</script>
</head>
<body>
<div id="backlogBtn" style="display: block;">== (animated loading gif me!) ==</div>
<div id="messages"></div>
<div id="newmsgbar" onClick="window.scrollTo(0, document.body.scrollHeight)"></div>
</body>
</html>